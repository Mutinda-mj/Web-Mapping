<!DOCTYPE html>
<html>
<head>
    <title>Viewpoint Interactive Web Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

    <style>
        /* 1. Page Layout Structure */
        body, html {
            height: 100%;
            margin: 0;
            overflow: hidden;
            display: flex;       /* Use Flexbox for vertical layout */
            flex-direction: column;
        }

        /* Navbar stays at the top (flex item) */
        nav { flex: 0 0 auto; }

        /* Map Container takes all remaining space */
        .tab-content { flex: 1 1 auto; position: relative; overflow: hidden; }
        .tab-pane { height: 100%; }

        /* Footer stays at the bottom (flex item) */
        footer {
            flex: 0 0 auto;
            background-color: #343a40; /* Dark bg matches navbar */
            color: #ccc;
            padding: 10px 20px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 2000;
        }

        /* 2. Map & Sidebar Specifics */
        #map-container {
            display: flex;
            height: 100%;
            width: 100%;
            position: relative;
        }

        #sidebar {
            width: 300px;
            background-color: #f8f9fa;
            border-right: 1px solid #ddd;
            transition: margin-left 0.3s;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        #sidebar.collapsed { margin-left: -300px; }

        .sidebar-header { padding: 15px; background: #343a40; color: white; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-content { padding: 15px; overflow-y: auto; flex-grow: 1; }

        #map { flex-grow: 1; height: 100%; width: 100%; z-index: 0; }

        #sidebar-toggle {
            position: absolute; top: 10px; left: 310px; z-index: 1001; transition: left 0.3s;
        }
        #sidebar-toggle.collapsed { left: 10px; }

        /* 3. Custom Pan Control Styling */
        .leaflet-control-pan {
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 50px;
        }
        .pan-row { display: flex; }
        .pan-btn {
            width: 20px;
            height: 20px;
            cursor: pointer;
            text-align: center;
            line-height: 20px;
            font-size: 12px;
            color: #333;
        }
        .pan-btn:hover { color: #007bff; font-weight: bold; }

    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="#">ViewPoint</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav" role="tablist">
                <li class="nav-item"><a class="nav-link active" id="home-tab" data-toggle="tab" href="#home" role="tab">Map View</a></li>
                <li class="nav-item"><a class="nav-link" id="search-tab" data-toggle="tab" href="#search" role="tab">Search</a></li>
                <li class="nav-item"><a class="nav-link" id="about-tab" data-toggle="tab" href="#about" role="tab">About</a></li>
            </ul>
        </div>
    </nav>

    <div class="tab-content" id="myTabContent">

        <div class="tab-pane fade show active" id="home" role="tabpanel">
            <div id="map-container">

                <div id="sidebar">
                    <div class="sidebar-header">
                        <h5>Layers & Data</h5>
                        <button class="btn btn-sm btn-outline-light" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="sidebar-content">
                        <div class="card mb-3">
                            <div class="card-header bg-info text-white">Add Data</div>
                            <div class="card-body p-2">
                                <small class="text-muted">Upload <b>.zip</b> (Shapefile), <b>.tif</b> (GeoTIFF) or <b>.geojson</b></small>
                                <div class="custom-file mt-2">
                                    <!-- UPDATED: Accept .json and .geojson files -->
                                    <input type="file" class="custom-file-input" id="fileInput" accept=".zip,.tif,.tiff,.json,.geojson">
                                    <label class="custom-file-label" for="fileInput">Choose file...</label>
                                </div>
                            </div>
                        </div>
                        <h6>Active Layers</h6>
                        <div id="layer-list">
                            <div class="text-muted text-center font-italic" id="no-layers-msg">No layers added</div>
                        </div>
                    </div>
                </div>

                <button id="sidebar-toggle" class="btn btn-light border shadow-sm" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>

                <div id="map"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="search" role="tabpanel">
            <div class="container mt-4">
                <h3>Location Search</h3>
                <div class="input-group mb-3" style="max-width: 500px;">
                    <input type="text" id="search-input" class="form-control" placeholder="Enter location...">
                    <div class="input-group-append">
                        <button class="btn btn-primary" onclick="searchLocation()">Search</button>
                    </div>
                </div>
                <div id="search-results"></div>
            </div>
        </div>

        <div class="tab-pane fade" id="about" role="tabpanel">
            <div class="container mt-4">
                <h3>About</h3>
                <p>This application supports Shapefile (ZIP), GeoTIFF, and GeoJSON visualization.</p>
            </div>
        </div>
    </div>

    <footer>
        <div>
            <strong>Support:</strong> <a href="mailto:support@geomanager.com" class="text-light">support@ViewPoint.com</a> | +254 706 004 297
        </div>
        <div>
            <strong>Developer HQ:</strong> Nairobi, Kenya
        </div>
    </footer>

    <div class="modal fade" id="attributeModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Feature Attributes</h5>
                    <button type="button" class="close" data-dismiss="modal"><span>&times;</span></button>
                </div>
                <div class="modal-body">
                    <table class="table table-striped table-sm" id="attributeTable"></table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
    <script src="https://unpkg.com/georaster"></script>
    <script src="https://unpkg.com/georaster-layer-for-leaflet/georaster-layer-for-leaflet.min.js"></script>

    <script>
        // --- START of Map Initialization and Drawing Setup ---
        // 1. Initialize Map (Disable default zoom to move it)
        var map = L.map('map', {
            zoomControl: false // We will add it back in a custom position
        }).setView([0, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 2. Feature Group for Drawn Items (to hold user-drawn features)
        var drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // 3. Initialize the Draw Control
        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: drawnItems
            },
            draw: {
                polyline: true,
                polygon: true,
                rectangle: true,
                circle: false,
                marker: true,
                circlemarker: false
            }
        });
        map.addControl(drawControl);

        // 4. Handle Feature Creation Event (from previous request)
        map.on(L.Draw.Event.CREATED, function (event) {
            var layer = event.layer;

            // Get the GeoJSON representation of the new feature
            var geojsonFeature = layer.toGeoJSON();

            // Prompt the user for a property value (e.g., 'name')
            var featureName = prompt("Enter a name for this new feature:", "New Feature");

            // Add the property to the GeoJSON object
            if (featureName) {
                geojsonFeature.properties = {
                    'name': featureName,
                };

                // Add the new layer to the drawing group
                drawnItems.addLayer(layer);

                // Bind a popup to show the name
                layer.bindPopup("Name: <b>" + featureName + "</b>").openPopup();

                console.log("New Feature GeoJSON:", geojsonFeature);
                alert(`Feature '${featureName}' created! Check the console for GeoJSON.`);

            } else {
                layer.remove();
                alert("Feature creation cancelled.");
            }
        });

        // 5. Add Zoom Control to Top Right
        L.control.zoom({
            position: 'topright'
        }).addTo(map);

        // 6. Custom Pan Control (Top Right)
        var PanControl = L.Control.extend({
            options: { position: 'topright' },
            onAdd: function(map) {
                var container = L.DomUtil.create('div', 'leaflet-control-pan leaflet-bar');
                container.innerHTML = `
                    <div class="pan-row"><div class="pan-btn" id="pan-up"><i class="fas fa-chevron-up"></i></div></div>
                    <div class="pan-row">
                        <div class="pan-btn" id="pan-left"><i class="fas fa-chevron-left"></i></div>
                        <div class="pan-btn" style="cursor:default; width:10px;"></div>
                        <div class="pan-btn" id="pan-right"><i class="fas fa-chevron-right"></i></div>
                    </div>
                    <div class="pan-row"><div class="pan-btn" id="pan-down"><i class="fas fa-chevron-down"></i></div></div>
                `;
                L.DomEvent.disableClickPropagation(container);
                return container;
            },
        });
        map.addControl(new PanControl());

        // Bind Pan Actions
        setTimeout(() => {
            document.getElementById('pan-up').onclick = function() { map.panBy([0, -100]); };
            document.getElementById('pan-down').onclick = function() { map.panBy([0, 100]); };
            document.getElementById('pan-left').onclick = function() { map.panBy([-100, 0]); };
            document.getElementById('pan-right').onclick = function() { map.panBy([100, 0]); };
        }, 500);

        // --- END of Map Initialization and Drawing Setup ---


        // --- CORE FUNCTIONALITY ---

        var layers = {};
        var layerIdCounter = 0;

        function toggleSidebar() {
            var sidebar = document.getElementById('sidebar');
            var btn = document.getElementById('sidebar-toggle');
            sidebar.classList.toggle('collapsed');
            btn.classList.toggle('collapsed');
            setTimeout(function() { map.invalidateSize(); }, 350);
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            var file = e.target.files[0];
            if (!file) return;
            $(this).next('.custom-file-label').html(file.name);
            var fileName = file.name;
            var reader = new FileReader();

            if (fileName.endsWith('.zip')) {
                reader.onload = function(buffer) {
                    shp(buffer.target.result).then(function(geojson) {
                        addVectorLayer(geojson, fileName);
                    }).catch(err => console.error("Error parsing Shapefile:", err) || alert("Error parsing Shapefile: " + err));
                }
                reader.readAsArrayBuffer(file);
            }
            else if (fileName.endsWith('.tif') || fileName.endsWith('.tiff')) {
                reader.onload = function(buffer) {
                    parseGeoraster(buffer.target.result).then(function(georaster) {
                        var layer = new GeoRasterLayer({
                            georaster: georaster,
                            opacity: 0.7,
                            resolution: 96
                        });
                        addRasterLayer(layer, fileName);
                    }).catch(err => console.error("Error parsing GeoTIFF:", err) || alert("Error parsing GeoTIFF: " + err));
                }
                reader.readAsArrayBuffer(file);
            }
            // NEW LOGIC FOR GEOJSON
            else if (fileName.endsWith('.json') || fileName.endsWith('.geojson')) {
                reader.onload = function(e) {
                    try {
                        var geojson = JSON.parse(e.target.result);
                        addVectorLayer(geojson, fileName);
                    } catch (error) {
                        console.error("Error parsing GeoJSON file:", error);
                        alert("Error parsing GeoJSON file. Please ensure it is a valid JSON structure.");
                    }
                }
                reader.readAsText(file);
            }
            // END NEW LOGIC
            else {
                alert("Please upload a .zip (Shapefile), .tif (GeoTIFF) or .geojson file.");
            }
        });

        function addVectorLayer(data, name) {
            var color = getRandomColor();
            var layer = L.geoJSON(data, {
                style: function (feature) { return { color: color, weight: 2 }; },
                onEachFeature: function (feature, layer) {
                    // Attach right-click event to show attributes
                    layer.on('contextmenu', function(e) { showAttributeTable(feature.properties); });
                    layer.bindTooltip("Right-click for attributes");
                }
            }).addTo(map);

            // Check if bounds are valid before fitting
            if (layer.getBounds().isValid()) {
                map.fitBounds(layer.getBounds());
            } else {
                console.warn("GeoJSON layer has invalid bounds (possibly empty or invalid geometry). Not zooming.");
            }

            addToLayerControl(layer, name);
        }

        function addRasterLayer(layer, name) {
            layer.addTo(map);
            map.fitBounds(layer.getBounds());
            addToLayerControl(layer, name);
        }

        function showAttributeTable(props) {
            var table = document.getElementById('attributeTable');
            table.innerHTML = "";
            if (!props || Object.keys(props).length === 0) {
                table.innerHTML = "<tr><td>No attributes found</td></tr>";
            } else {
                var thead = "<thead><tr><th>Property</th><th>Value</th></tr></thead><tbody>";
                for (var key in props) {
                    // Simple sanitation for display
                    var value = (typeof props[key] === 'object' && props[key] !== null) ? JSON.stringify(props[key]) : props[key];
                    thead += `<tr><td><strong>${key}</strong></td><td>${value}</td></tr>`;
                }
                thead += "</tbody>";
                table.innerHTML = thead;
            }
            $('#attributeModal').modal('show');
        }

        function addToLayerControl(layer, name) {
            document.getElementById('no-layers-msg').style.display = 'none';
            var id = 'layer-' + layerIdCounter++;
            layers[id] = layer;
            var html = `
                <div class="layer-item" id="item-${id}" style="background:white; border:1px solid #eee; padding:5px; margin-bottom:5px; border-radius:4px; display:flex; justify-content:space-between; align-items:center;">
                    <div><input type="checkbox" checked onchange="toggleLayerVisibility('${id}')"> <span style="font-size:14px;">${name}</span></div>
                    <button class="btn btn-sm btn-danger" onclick="removeLayer('${id}')">&times;</button>
                </div>
            `;
            document.getElementById('layer-list').insertAdjacentHTML('beforeend', html);
        }

        function toggleLayerVisibility(id) {
            if (map.hasLayer(layers[id])) map.removeLayer(layers[id]);
            else map.addLayer(layers[id]);
        }

        function removeLayer(id) {
            if (map.hasLayer(layers[id])) map.removeLayer(layers[id]);
            delete layers[id];
            document.getElementById('item-' + id).remove();
            if (Object.keys(layers).length === 0) {
                 document.getElementById('no-layers-msg').style.display = 'block';
            }
        }

        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) color += letters[Math.floor(Math.random() * 16)];
            return color;
        }

        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            if (e.target.id === 'home-tab') map.invalidateSize();
        });

        function searchLocation() {
            var query = document.getElementById('search-input').value;
            if(!query) return;
            fetch('https://nominatim.openstreetmap.org/search?q=' + encodeURIComponent(query) + '&format=json&limit=1')
            .then(r => r.json()).then(data => {
                if (data && data.length > 0) {
                    var lat = data[0].lat, lon = data[0].lon;
                    map.setView([lat, lon], 13);
                    L.marker([lat, lon]).addTo(map).bindPopup(data[0].display_name).openPopup();
                    $('#home-tab').tab('show');
                } else { alert("Location not found"); }
            });
        }
    </script>
</body>
</html>
